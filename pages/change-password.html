<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="../manifest.json">
  <meta name="theme-color" content="#C0392B">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Lingora">
  <link rel="apple-touch-icon" href="../assets/icons/icon-192.png">
  <title>Ganti Password - Lingora</title>
  <link rel="stylesheet" href="../assets/css/main.css">
  <link rel="stylesheet" href="../assets/css/layout.css">
  <link rel="stylesheet" href="../assets/css/components.css">
  <link rel="stylesheet" href="../assets/css/themes.css">
  <style>
    /* Center the change-password form in the available content area */
    .cp-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: calc(100vh - var(--topbar-h) - 80px);
      padding-top: 20px;
    }
    .cp-container {
      width: 100%;
      max-width: 460px;
    }
    .cp-icon-header {
      text-align: center;
      margin-bottom: 24px;
    }
    .cp-icon-circle {
      width: 72px; height: 72px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--red-soft), #fff);
      border: 2px solid var(--red-soft);
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 2rem;
      margin-bottom: 12px;
      box-shadow: 0 4px 20px rgba(192,57,43,0.12);
    }
    .cp-icon-header h2 {
      font-family: var(--font-display);
      font-size: 1.4rem;
      color: var(--text);
    }
    .cp-icon-header p {
      font-size: 0.85rem;
      color: var(--text-3);
      margin-top: 4px;
    }
  </style>
  <script>
    // Fase 10+28: Apply theme & kustomisasi sebelum render untuk mencegah FOUC
    (function() {
      try {
        var theme = localStorage.getItem('nh_last_theme');
        if (!theme) {
          theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        document.documentElement.setAttribute('data-theme', theme);
        // Fase 28: color theme, font, radius
        var ct = localStorage.getItem('nh_color_theme') || 'sakura';
        document.documentElement.setAttribute('data-color-theme', ct);
        var font = localStorage.getItem('nh_font');
        if (font && font !== 'default') document.documentElement.setAttribute('data-font', font);
        var radius = localStorage.getItem('nh_radius') || 'default';
        document.documentElement.setAttribute('data-radius', radius);
      } catch(e) {}
    })();
  </script>
</head>
<body>
<div class="app-shell">

  <nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-main">Lingora</div>
      <div class="logo-sub">Jepang, Mandarin &amp; Korea</div>
    </div>
    <div class="sidebar-user">
      <div class="avatar-circle" data-user-avatar>Êó•</div>
      <div class="sidebar-user-info">
        <div class="user-name" data-user-name>Pengguna</div>
        <div class="user-level" data-user-email>-</div>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section-label">Umum</div>
      <a class="nav-item" href="dashboard.html" data-page="dashboard"><span class="nav-icon">&#9632;</span>Dashboard</a>
      <a class="nav-item" href="stats.html" data-page="stats"><span class="nav-icon">&#128202;</span>Statistik</a>
      <a class="nav-item" href="settings.html" data-page="settings"><span class="nav-icon">&#9881;</span>Pengaturan</a>
      <a class="nav-item" href="report.html" target="_blank" data-page="report"><span class="nav-icon">&#128438;</span>Ekspor PDF</a>

      <div class="nav-section-label">Bahasa Jepang</div>
      <a class="nav-item" href="japanese/hiragana.html" data-page="hiragana"><span class="nav-icon cjk">„ÅÇ</span>Hiragana</a>
      <a class="nav-item" href="japanese/katakana.html" data-page="katakana"><span class="nav-icon cjk">„Ç¢</span>Katakana</a>
      <a class="nav-item" href="japanese/kanji.html" data-page="kanji"><span class="nav-icon cjk">Êº¢</span>Kanji</a>
      <a class="nav-item" href="japanese/vocabulary.html" data-page="jp-vocab"><span class="nav-icon">&#128218;</span>Kosakata JP</a>
      <a class="nav-item" href="japanese/grammar.html" data-page="jp-grammar"><span class="nav-icon">&#128221;</span>Grammar JP</a>
      <a class="nav-item" href="japanese/dialog.html" data-page="jp-dialog"><span class="nav-icon">&#128172;</span>Dialog JP</a>

      <div class="nav-section-label">Bahasa Mandarin</div>
      <a class="nav-item" href="mandarin/pinyin.html" data-page="pinyin"><span class="nav-icon cjk">Êãº</span>Pinyin</a>
      <a class="nav-item" href="mandarin/tones.html" data-page="tones"><span class="nav-icon">&#9835;</span>Nada (Tones)</a>
      <a class="nav-item" href="mandarin/hanzi.html" data-page="hanzi"><span class="nav-icon cjk">Ê±â</span>Hanzi</a>
      <a class="nav-item" href="mandarin/vocabulary.html" data-page="zh-vocab"><span class="nav-icon">&#128218;</span>Kosakata ZH</a>
      <a class="nav-item" href="mandarin/dialog.html" data-page="zh-dialog"><span class="nav-icon">&#128172;</span>Dialog ZH</a>

      <div class="nav-section-label">Bahasa Korea</div>
      <a class="nav-item" href="korean/hangul.html" data-page="hangul"><span class="nav-icon cjk">Ìïú</span>Hangul</a>
      <a class="nav-item" href="korean/vocabulary.html" data-page="kr-vocab"><span class="nav-icon">&#128218;</span>Kosakata KR</a>
      <a class="nav-item" href="korean/grammar.html" data-page="kr-grammar"><span class="nav-icon">&#128221;</span>Grammar KR</a>
      <a class="nav-item" href="korean/dialog.html" data-page="kr-dialog"><span class="nav-icon">&#128172;</span>Dialog KR</a>

      <div class="nav-section-label">Latihan</div>
      <a class="nav-item" href="japanese/quiz.html" data-page="quiz-jp"><span class="nav-icon">&#9733;</span>Quiz Jepang</a>
      <a class="nav-item" href="mandarin/quiz.html" data-page="quiz-zh"><span class="nav-icon">&#9733;</span>Quiz Mandarin</a>
      <a class="nav-item" href="korean/quiz.html" data-page="quiz-kr"><span class="nav-icon">&#9733;</span>Quiz Korea</a>
      <a class="nav-item" href="games.html" data-page="games"><span class="nav-icon">&#127918;</span>Mini Game</a>

      <div class="nav-section-label">Akun</div>
      <a class="nav-item" href="profile.html" data-page="profile"><span class="nav-icon">&#128100;</span>Profil</a>
      <a class="nav-item" href="onboarding.html" data-page="onboarding"><span class="nav-icon">&#127919;</span>Profil Belajar</a>
      <a class="nav-item" href="planner.html" data-page="planner"><span class="nav-icon">&#128197;</span>Study Planner</a>
      <a class="nav-item active" href="change-password.html" data-page="change-password"><span class="nav-icon">&#128274;</span>Ganti Password</a>
      <a class="nav-item" href="#" data-action="logout"><span class="nav-icon">&#128682;</span>Keluar</a>
    </nav>
  </nav>
  <div class="drawer-overlay" id="drawer-overlay"></div>

  <div class="main-content">
    <header class="topbar">
      <span class="topbar-title">Ganti Password</span>
      <button class="theme-toggle-btn" id="theme-toggle-btn" title="Beralih ke Mode Gelap">üåô</button>
    </header>
    <header class="mobile-topbar">
      <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
      <span class="logo-main">Lingora</span>
      <button class="theme-toggle-btn" id="theme-toggle-btn-mobile" title="Mode Gelap">üåô</button>
    </header>

    <main class="page-body fade-in">
      <div class="cp-wrapper">
        <div class="cp-container">

          <!-- Icon header -->
          <div class="cp-icon-header">
            <div class="cp-icon-circle">üîí</div>
            <h2>Ubah Password</h2>
            <p>Pastikan password baru kamu kuat dan mudah diingat</p>
          </div>

          <div class="card">
            <form id="change-pass-form" novalidate>

              <div class="form-group">
                <label class="form-label" for="old-pass">Password Lama</label>
                <div class="input-wrapper">
                  <span class="input-icon">&#128274;</span>
                  <input type="password" id="old-pass" class="form-control" placeholder="Password saat ini">
                  <span class="input-toggle" id="toggle-old">&#128065;</span>
                </div>
                <span class="form-error" id="old-error"></span>
              </div>

              <div class="form-group">
                <label class="form-label" for="new-pass">Password Baru</label>
                <div class="input-wrapper">
                  <span class="input-icon">&#128275;</span>
                  <input type="password" id="new-pass" class="form-control" placeholder="Min. 6 karakter">
                  <span class="input-toggle" id="toggle-new">&#128065;</span>
                </div>
                <div class="password-strength" id="strength-indicator" style="display:none;">
                  <div class="strength-bar" id="bar1"></div>
                  <div class="strength-bar" id="bar2"></div>
                  <div class="strength-bar" id="bar3"></div>
                  <span class="strength-label" id="strength-label"></span>
                </div>
                <span class="form-error" id="new-error"></span>
              </div>

              <div class="form-group" style="margin-bottom:24px;">
                <label class="form-label" for="confirm-pass">Konfirmasi Password Baru</label>
                <div class="input-wrapper">
                  <span class="input-icon">&#128275;</span>
                  <input type="password" id="confirm-pass" class="form-control" placeholder="Ulangi password baru">
                </div>
                <span class="form-error" id="confirm-error"></span>
              </div>

              <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <button type="submit" class="btn btn-primary" id="save-btn" style="flex:1;">Simpan Password</button>
                <a href="profile.html" class="btn btn-ghost">Batal</a>
              </div>

            </form>
          </div>

          <div class="card" style="margin-top:16px;background:var(--gold-soft);border-color:rgba(212,175,55,0.3);">
            <p style="font-size:0.85rem;color:var(--gold-dark);line-height:1.6;">
              üí° Password yang kuat mengandung kombinasi huruf besar, huruf kecil, angka, dan simbol.
              Minimal 6 karakter.
            </p>
          </div>

        </div>
      </div>
    </main>
  </div>

  <nav class="bottom-nav">
    <div class="bottom-nav-inner">
      <a class="bottom-nav-item" href="dashboard.html"><span class="bnav-icon">&#9632;</span><span>Dashboard</span></a>
      <a class="bottom-nav-item" href="japanese/hiragana.html"><span class="bnav-icon cjk">„ÅÇ</span><span>Jepang</span></a>
      <a class="bottom-nav-item" href="mandarin/pinyin.html"><span class="bnav-icon cjk">Êãº</span><span>Mandarin</span></a>
      <a class="bottom-nav-item active" href="profile.html"><span class="bnav-icon">&#128100;</span><span>Profil</span></a>
    </div>
  </nav>
</div>
<div id="toast-container"></div>

<script src="../assets/js/core/storage.js"></script>
<script src="../assets/js/core/auth.js"></script>
<script src="../assets/js/core/router.js"></script>
<script src="../assets/js/core/app.js"></script>
<script src="../assets/js/modules/theme.js"></script>
<script>
  if (!Router.guard()) throw '';
  App.init('change-password');

  const user       = Auth.getActiveUser();
  const form       = document.getElementById('change-pass-form');
  const oldEl      = document.getElementById('old-pass');
  const newEl      = document.getElementById('new-pass');
  const confirmEl  = document.getElementById('confirm-pass');
  const oldErr     = document.getElementById('old-error');
  const newErr     = document.getElementById('new-error');
  const confirmErr = document.getElementById('confirm-error');
  const saveBtn    = document.getElementById('save-btn');
  const strengthEl = document.getElementById('strength-indicator');
  const bars       = [document.getElementById('bar1'),document.getElementById('bar2'),document.getElementById('bar3')];
  const labelEl    = document.getElementById('strength-label');

  document.getElementById('toggle-old').addEventListener('click', () => {
    oldEl.type = oldEl.type === 'password' ? 'text' : 'password';
  });
  document.getElementById('toggle-new').addEventListener('click', () => {
    newEl.type = newEl.type === 'password' ? 'text' : 'password';
  });

  newEl.addEventListener('input', () => {
    App.clearError(newEl, newErr);
    if (!newEl.value) { strengthEl.style.display = 'none'; return; }
    strengthEl.style.display = 'flex';
    const { score, cls, label } = App.checkPasswordStrength(newEl.value);
    bars.forEach((b, i) => { b.className = 'strength-bar'; if (i < score) b.classList.add(cls); });
    labelEl.textContent = label;
  });

  oldEl.addEventListener('input',     () => App.clearError(oldEl,     oldErr));
  confirmEl.addEventListener('input', () => App.clearError(confirmEl, confirmErr));

  form.addEventListener('submit', e => {
    e.preventDefault();
    App.clearAllErrors(form);

    let err = false;
    if (!oldEl.value)                        { App.showError(oldEl,     oldErr,     'Masukkan password lama.'); err = true; }
    if (newEl.value.length < 6)              { App.showError(newEl,     newErr,     'Password baru minimal 6 karakter.'); err = true; }
    if (newEl.value !== confirmEl.value)     { App.showError(confirmEl, confirmErr, 'Password tidak cocok.'); err = true; }
    if (err) return;

    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner"></span>';

    setTimeout(() => {
      const result = Auth.changePassword(user.id, { oldPassword: oldEl.value, newPassword: newEl.value });
      if (result.ok) {
        App.toast('Password berhasil diubah! üéâ', 'success');
        form.reset();
        strengthEl.style.display = 'none';
      } else {
        App.showFormAlert(form, result.error, 'alert-error');
      }
      saveBtn.disabled = false;
      saveBtn.innerHTML = 'Simpan Password';
    }, 300);
  });
</script>
<script src="../assets/js/modules/pwa.js"></script>
<script>document.addEventListener("DOMContentLoaded", () => PWAManager.init());</script>
</body>
</html>
